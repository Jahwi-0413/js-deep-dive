# 23 실행 컨텍스트

## 23.1 소스코드 타입

ECMAScript에서는 소스 코드를 4가지 타입으로 분류함

1. 전역 코드
   전역 코드 평가시 전역 실행 컨텍스트 생성
2. 함수 코드
   지역 스코프를 생성해 지역 변수, 매개변수, arguments 객체 관리
   함수 코드 평가시 함수 실행 컨텍스트 생성
3. eval 코드
   strict mode에서는 자신만의 스코프를 생성함
   eval 코드 평가시 eval 실행 컨텍스트 생성
4. 모듈 코드
   모듈별로 독릷적인 스코프를 생성
   모듈 코드 평가시 모듈 실행 컨텍스트 생성

## 23.2 소스코드의 평가와 실행

소스코드는 소스코드 평가, 소스코드 실행 과정으로 나누어 처리함

평가 과정에서는 실행 컨텍스트를 생성하고 변수, 함수 등의 선언문만 먼저 실행해 실행 컨텍스트가 관리하는 스코프에 등록함
평가 과정이 끝나면 선언문을 제외한 소스코드를 실행함

## 23.3 실행 컨텍스트의 역할

실행 컨텍스트는 소스코드를 실행하는데 필요한 환경을 제공하고 코드의 실행 결과를 관리함

1. 모든 식별자의 스코프를 구분해 등록하고 상태 변화를 지속적으로 관리
2. 스코프 체인을 통해 상위 스코프의 식별자도 검색할 수 있어야 함
3. 실행중인 코드의 실행 순서를 변경

```javascript
const x = 1;

function foo(a) {
  const x = 10;

  console.log(x + a); //13
}

foo(3);
```

위의 코드 실행 순서를 설명하면 다음과 같음

1. 전역 코드 평가
   변수 선언문, 함수 선언문 실행
2. 전역 코드 실행
   런타임이 시작되어 전역 코드 실행
   함소 호출시 전역 코드 실행을 중단하고 함수 내부로 진입함
3. 함수 코드 평가
   함수 코드를 실행할 준비.
   매개변수와 지역 변수 선언문이 먼저 실행하고 지역 스코프에 등록됨
   arguments 객체가 생성되어 지역 스코프에 등록, this 바인딩 결정
4. 함수 코드 실행
   console은 전역 객체의 프로퍼티이다. log는 console의 프로토타입 체인을 통해 검색한다.
   그 후 x + a는 스코프 체인을 통해 검색하는데 x는 지역 스코프에 등록되어 있어 전역 객체 x가 아닌 지역 변수 x를 참조하게 된다

## 23.4 실행 컨텍스트 스택

실행 컨텍스트는 스택으로 관리되고 코드의 실행 순서를 관리한다.
실행 컨텍스트 스택의 최상위의 실행 컨텍스트는 항상 현지 실행중인 코드의 실행 컨텍스트이다.

## 23.5 렉시컬 환경

렉시컬 환경은 식별자와 식별자에 바인딩된 값, 상위 스코프에 대한 참조를 기록하는 자료구조
실행 컨텍스트의 컴포넌트이다.

실행 컨텍스트는 LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트로 구성됨

Lexical Environment는 Environment Record(환경 레코드)와 OuterLexicalEnvironmentReference(외부 렉시컬 환경에 대한 참조)로 구성된다
환경 레코드는 스코프에 포함된 식별자를 등록하고 식별자에 바인딩된 값을 관리함. 소스코드 타입에 따라 관리하는 내용에 차이가 있음
외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킴. 링크드 리스트 형태의 스코프 체인을 구현함

## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정

다음 예제로 파악해보자

```javascript
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }
}
```

### 23.6.1 전역 객체 생성

전역 객체는 전역 코드 평가 이전에 생성됨. 표준 빌트인 객체, 동작 환경 또는 특정 환경을 위한 호스트 객체도 생성된다.

### 23.6.2 전역 코드 평가

#### 1. 전역 실행 컨텍스트 생성

빈 전역 실행 컨텍스트를 생성해 실행 컨텍스트 스택에 푸시함

#### 2. 전역 레시컬 환경 생성

1. 전역 환경 레코드 생성
   var 키워드로 선언한 변수와 let, const로 선언한 변수를 구분하기 위해 전역 환경 레코드는 객체 환경 레코드와 선언적 환경 레코드로 구성됨
   객체 환경 레코드 -> var 키워드로 선언한 전역 변수와 전역 함수, 빌트인 전역 프로퍼티와 빌트인 전역 함수, 표준 빌트인 객체 관리
   선언적 환경 레코드 -> let, const 키워드로 선언한 전역 변수 관리. 일시적 사각지대(TDZ)

2. this 바인딩
   전역 환경 레코드의 `[[GlobalThisValue]]` 내부 슬롯에 this가 바인딩됨
   this 바인딩은 전역 환경 레코드와 함수 환경 레코드에만 존재함

3. 외부 렉시컬 환경에 대한 참조 결정
   전역 코드를 포함하는 소스코드는 없으므로 전역 렉시컬 환경의 외부 렉시컬 환경에 대한 참조에는 null이 할당됨 -> 스코프 체인의 종점

### 23.6.3 전역 코드 실행

x, y에 값이 할당되고 foo 함수가 호출됨
식별자를 어느 스코프에서 참조할지 결정하는것을 **식별자 결정**이라 함
식별자 결정을 하기 위해 실행중인 실행 컨텍스트에서 식별자를 검색한다.

### 23.6.4 foo 함수 코드 평가

foo 함수 호출시 전역 코드 실행을 중단하고 foo 함수 내부로 코드 제어권이 이동함.

#### 1. 함수 실행 컨텍스트 생성

foo 함수의 실행 컨텍스트를 생성해 스택에 푸시함. foo 함수 실행 컨텍스트는 실행중인 실행 컨텍스트가 된다.

#### 2. 함수 렉시컬 환경 생성

foo 함수 렉시컬 환경을 생성해 foo 함수 실행 컨텍스트에 바인딩함

1. 함수 환경 레코드 생성
   매개변수, arguments 객체, 지역 변수와 중첩 함수를 관리

2. this 바인딩
   함수 환경 레코드의 `[[ThisValue]]` 내부 슬롯에 this 바인딩

3. 외부 렉시컬 환경에 대한 참조 결정
   foo 함수는 전역 함수이므로 foo 함수의 외부 렉시컬 환경에 대한 참조에는 전역 렉시컬 환경의 참조가 할당됨

### 23.6.5 foo 함수 코드 실행

foo 함수의 소스코드를 실행하다가 bar 함수 호출이 된다.
foo 함수 내부의 x, y의 식별자 결정을 위해 실행 컨텍스트의 렉시컬 환경에서 식별자를 검색한다.

### 23.6.6 bar 함수 코드 평가

### 23.6.7 bar 함수 코드 실행

1. console 식별자 검색
   스코프 체인에서 console 식별자를 검색함. 스코프 체인은 실행 중인 실행 컨텍스트의 렉시컬 환경에서 외부 렉시컬 환경에 대한 참조를 통해 검색한다.
   실행중인 실행 컨텍스트는 bar 함수 실행 컨텍스트이므로 bar 함수 렉시컬 환경에서 console 식별자를 검색함.
   하지만 업식 때문에 상위 스코프로 이동하면서 console 식별자를 검색함
   전역 객체에서 console 식별자를 찾게됨

2. log 메서드 검색
   console 객체에서 log 메서드를 검색함.

3. 표현식 a+b+x+y+z 평가
   a는 foo 함수 렉시컬 환경에서, b는 bar 함수 렉시컬 환경에서, x와 y는 foo 함수 렉시컬 환경에서, z 식별자는 bar 함수 렉시컬 환경에서 검색됨

4. console.log 메서드 호출

### 23.6.8 bar 함수 코드 실행 종료

### 23.6.9 foo 함수 코드 실행 종료

### 23.6.10 전역 코드 실행 종료

## 23.7 실행 컨텍스트와 블록 레벨 스코프

var 키워드로 선언한 변수는 함수의 코드 블록만 지역 스코프로 인정 (함수 레벨 스코프)
let, const 키워드로 선언한 변수는 모든 코드 블록을 지역 스코프로 인정 (블록 레벨 스코프)
