# 38장 브라우저의 렌더링 과정

브라우저가 렌더링 과정

1. 서버에게 렌더링에 필요한 리소스를 요청 후 응답받는다.
2. 브라우저의 렌더링 엔진이 html과 css를 파싱해 dom과 cssom을 생성하고 결합해 렌더 트리를 생성한다.
3. 브라우저의 자바스크립트 엔진이 서버로부터 받은 javascript를 파싱해 AST (Abstracdt Syntax Tree)를 생성하고
   바이트코드로 변환해 실행한다. 자바스크립트는 DOM API로 dom이나 cssom을 변경할 수 있다.
   변경된 dom과 cssom은 다시 렌더 트리로 결합된다.
4. 렌더 트리를 기반으로 html 요소의 레이아웃을 계산하고 브라우저 화면에 html 요소를 페인팅한다.

## 38.1 요청과 응답

요청

1. 브라우저의 주소창에 url을 입력하고 엔터키를 누름
2. url의 호스트 이름이 dns를 통해 ip로 변환
3. 해당 ip를 가진 서버에 요청 전송

주소 구성
URI = URL + URN
URL = scheme(protocol) + host(domain) + port + path
URN = query(query string) + fragment

응답

- 루트 요청시에는 index.html을 클라이언트로 응답함
- 특정 파일을 요청할 경우에는 path 를 달리 해 정적 파일을 요청한다
- 자바스크립트를 이용해 동적 데이터를 요청할 수 있다.

## 38.2 HTTP 1.1과 HTTP 2.0

HTTP -> 웹에서 브라우저와 서버가 통신하기 위한 프로토콜이다

- HTTP/1.1

  - 커넥션당 하나의 요청과 응답만 처리
  - 여러개의 요청을 한꺼번에 전송 불가, 한번에 여러 응답 불가능
  - 요청 리소스의 개수에 비례해 응답 시간 증가

- HTTP/2.0

  - 커넥션당 다중 요청/응답 가능
  - HTTP/1.1에 비해 페이지 로드 속도가 약 50%정도 빠름

## 38.3 HTML 파싱과 DOM 생성

- 서버로부터 응답받은 HTML 문서를 브라우저 렌더링 엔진이 파싱해 DOM 생성
  1. 서버는 부라우저가 요청한 HTML을 읽고 메모리에 저장해 메모리에 저장된 바이트를 브라우저에 응답한다.
  2. 브라우저는 서버가 응답한 HTML 문서(바이트)를 meta 태그의 charset attribute에 지정된 인코딩 방식(ex UTF-8)을 기준으로 문자열로 변환한다.
  3. 문자열로 변환된 html 문서를 토큰들로 분해.
  4. 토큰들을 객체화해 node 생성. 토큰의 내용에 따라 문서 노드, 요소 노드, 텍스트 노드, 어트리뷰트 노드가 생성됨.
  5. html 요소는 중첩 관계를 가질수도 있다. 이러한 부자 관계를 포함해 트리 자료구조로 생성한다.

토큰 -> 문법적 의미를 갖는 코드의 최소 단위

## 38.4 CSS 파싱과 CSSOM 생성

렌더링 엔진은 html의 파일의 처음부터 파싱하는데 파싱하다가 CSS 로드가 필요한 link 태그나 style 태그를 만나면 DOM 생성을 일시 중단함
CSS도 html과 같은 파싱 과정을 거친다 (바이트 -> 문자 -> 토큰 -> 노드 -> cssom)
cssom은 css의 상속을 반영해 생성된다.

## 38.5 렌더 트리 생성

dom과 cssom을 결합해 렌더 트리를 결합함
렌더 트리에는 화면에 렌더링되지 않는 노드(meta, script)와 비표시되는 노드(display : none)들은 포함하지 않음
렌더 트리 생성 후 html 요소의 레이아웃을 계산하는데 사용되고 브라우저 화면에 픽셀을 렌덜이하는 페인팅 처리에 입력됨

페인팅이 발생될 때

- 자바스크립트에 의한 노드 추가 또는 삭제
- 브라우저 창의 리사이징에 의한 뷰포트 크기 변경
- html 요소의 레이아웃에 변경을 발생시키는 스타일 변경 발생시
  - width/height
  - margin
  - padding
  - display 등등

## 38.6 자바스크립트 파싱과 실행

html 파싱중에 script 태그를 만나도 dom 생성을 중단한다.
script 태그의 src 어트리뷰트에 정의된 파일을 서버에 요청해 로드한 후에는 자바스크립트 엔진에 제어권을 넘김.
자바스크립트의 파싱과 실행이 종료되면 렌더링 엔진으로 제어권을 넘기고 html 파싱이 중단된 지점부터 다시 html 파싱을 시작한다.

자바스크립트의 파싱과 실행은 자바스크립트 엔진이 처리한다.
모든 자바스크립트 엔진은 ECMAScript 사양을 준수한다.
자바스크립트를 해석해 AST를 생성하고 인터프리터가 이를 실행해 중간 코드(바이트 코드)를 생성해 실행한다.

## 38.7 리플로우와 리페인트

- 리플로우 -> 레이아웃 계산을 다시 하는것

  - 노드 추가/삭제
  - 요소의 크기/위치 변경
  - 윈도우 리사이징
    등등

- 리페인트 -> 재결합된 렌더 트리를 기반으로 다시 페인트 하는 것

레이아웃에 영향이 없는 경우에는 리페인트만 실행됨

## 38.8 자바스크립트 파싱에 대한 HTML 파싱 중단

자바스크립트 파일이 파싱, 실행될 때 이미 생성되지 않은 dom에 접근하게 되는 경우를 조심해야함
이러한 문제 때문에 **body 태그 맨 밑에 script 태그를 위치**시키는것을 권장함

## 38.9 script 태그의 async/defer 어트리뷰트

자바스크립트 파싱시 dom 생성이 중단되는 문제를 해결하기 위한 방법이다

- async attribute
  - html 파싱과 자바스크립트 파일의 로드가 비동기적으로 동시에 실행됨
  - 자바스크립트 파싱과 실행은 자바스크립트의 파일의 로드가 완료된 직후해 진행
  - 파싱, 실행때는 html 파싱이 중단됨
  - script 태그의 순서와 상관없이 로드가 완료된 자바스크립트부터 실행되어 순서가 보장되지 않음
- defer attribute
  - async처럼 html 파싱과 자바스크립트 파일의 로드가 동시에 진행됨
  - html 파싱이 완료된 직후에 자바스크립트의 파싱과 실행이 진행됨
